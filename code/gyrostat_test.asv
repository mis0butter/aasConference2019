% gyrostat test functions 

w0 = [1; 1; 1]; 
q0 = [0; 0; 0; 1]; 
torque0 = [1; 2; 3]; 
inertia = [ 100     0       0; 
            0       100     0; 
            0       0       100]; 
tEnd = 10; 

%%

% Continuous may NOT be correct - direction of torque changes with each
% step. 
[t_c, y_c] = ode45(@(t,Z) gyrostat_cont(inertia, torque0, Z), [0, tEnd], [w0; q0]);
w_c = y_c(:, 1:3); 
q_c = y_c(:, 4:7); 

dt = 1/100; 

[t_d, q_d, w_d] = gyrostat_discrete(dt, 0, tEnd, inertia, torque0, w0, q0); 

%%

% another gyrostat continuous test function 

% Initial inputs 
w_in = w0; 
q_in = q0; 
torque = torque0; 

% Outputs
t_out = 0; 
w_out = w_in'; 
q_out = q_in'; 

% for t_i = 0 : dt : tEnd - dt 
for t_i = 0 : 1 : tEnd 
    
    [t, y] = ode45(@(t,Z) gyrostat_cont(inertia, torque, Z), [0, dt], [w_in; q_in]);
    w = y(:, 1:3); 
    q = y(:, 4:7); 
    w_in = w(end, :)'; 
    q_in = q(end, :)'; 
    
    DCM = SpinCalc('QtoDCM', q_in', eps, 0); 
    torque = DCM*torque;
    
    if isrow(t) == 1
        t = t'; 
    end 
    t_out = [t_out; t_out(end) + t(2:end)]; 
    w_out = [w_out; w(2:end, :)]; 
    q_out = [q_out; q(2:end, :)]; 

end
    
%% Plots 

figure
for i = 1:4
    subplot(4,1,i) 
        plot(t_c, q_c(:,i), t_d, q_d(:,i), t_out, q_out(:, i), '--')
        grid on
        ylabel(strcat('q', num2str(i)))
        if i == 1
            title('Continuous and Discrete Quaternions') 
            legend('Continuous', 'Discrete', 'Continuous-Discrete') 
        end 
end 
xlabel('Time (sec)') 

figure
for i = 1:3
    subplot(3,1,i)
        plot(t_c, w_c(:, i), t_d, w_d(:, i), t_out, w_out(:, i), '--')
        grid on 
        ylabel(strcat('w', num2str(i)))
        if i == 1
            title('Continuous and Discrete Angular Velocity') 
            legend('Continuous', 'Discrete', 'Continuous-Discrete') 
        end 
end 
xlabel('Time (sec)')